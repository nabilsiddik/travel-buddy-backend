generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

enum UserStatus {
  ACTIVE
  BLOCKED
  DELETED
}

enum Gender {
  MALE
  FEMALE
  OTHERS
}

enum TravelType {
  SOLO
  FAMILY
  FRIENDS
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum JoinStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  COMPLETED
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  incomplete
}

enum PlanType {
  monthly
  yearly
}

// Models
model User {
  id       String   @id @default(uuid())
  name     String
  email    String   @unique
  password String
  role     UserRole @default(USER)
  bio             String?
  profileImage    String?
  currentLocation String?
  gender          Gender
  interests        String[]
  visitedCountries String[]
  verifiedBadge    Boolean       @default(false)
  status           UserStatus    @default(ACTIVE)
  createdTravelPlans String[]

  // Relations
  travelPlans        TravelPlan[]                @relation("UserTravelPlans")
  joinRequests       TravelPlanJoinRequest[]     @relation("UserJoinRequests")
  participants       TravelPlanParticipant[]     @relation("UserParticipants")
  givenReviews       Review[]                    @relation("UserGivenReviews", fields: [], references: [])
  receivedReviews    Review[]                    @relation("UserReceivedReviews", fields: [], references: [])
  payments           Payment[]
  subscription       Subscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model TravelPlan {
  id          String     @id @default(uuid())
  userId      String
  destination String
  startDate   DateTime
  endDate     DateTime
  budgetRange String?
  travelType  TravelType
  description String?
  visibility  Boolean @default(true)
  isDeleted Boolean @default(false)

  // Relations
  user         User                   @relation("UserTravelPlans", fields: [userId], references: [id])
  participants TravelPlanParticipant[] @relation("PlanParticipants")
  joinRequests TravelPlanJoinRequest[] @relation("PlanJoinRequests")
  reviews      Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ParticipantStatus {
  PENDING
  ONGOING
  COMPLETED
  CANCELLED
}

model TravelPlanParticipant {
  id     String @id @default(uuid())
  planId String
  userId String
  joinedAt DateTime @default(now())

  status ParticipantStatus @default(PENDING)
  plan TravelPlan @relation("PlanParticipants", fields: [planId], references: [id])
  user User         @relation("UserParticipants", fields: [userId], references: [id])

  @@unique([planId, userId])
}

model TravelPlanJoinRequest {
  id          String     @id @default(uuid())
  planId      String
  requesterId String
  status      JoinStatus @default(PENDING)

  plan      TravelPlan @relation("PlanJoinRequests", fields: [planId], references: [id])
  requester User       @relation("UserJoinRequests", fields: [requesterId], references: [id])
}

model Review {
  id           String     @id @default(uuid())
  reviewerId   String
  targetUserId String
  planId       String
  rating       Int
  comment      String?

  reviewer   User        @relation("UserGivenReviews", fields: [reviewerId], references: [id])
  targetUser User        @relation("UserReceivedReviews", fields: [targetUserId], references: [id])
  plan       TravelPlan  @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())

  @@unique([reviewerId, targetUserId, planId])
}

model Payment {
  id String @id @default(uuid())
  userId String
  subscriptionId Int?

  amount   Float
  currency String @default("usd")
  stripeInvoiceId     String  @unique
  stripePaymentIntent String?
  status PaymentStatus @default(PENDING)

  user User @relation(fields: [userId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  createdAt DateTime @default(now())
}

model Subscription {
  id                   Int                @id @default(autoincrement())
  userId               String             @unique
  stripeCustomerId     String @unique
  stripeSubscriptionId String @unique
  status               SubscriptionStatus
  plan                 PlanType
  currentPeriodEnd     DateTime
  payments             Payment[]
  user                 User               @relation(fields: [userId], references: [id])
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}